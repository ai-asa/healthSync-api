# HealthSync ― iOS HealthKit 連携バックエンド

*iOS アプリが送ってくる歩数・脈拍などのライフログを受け取り、 リアルタイム集計してユーザにインサイトを返す* ――という想定で設計します。 求人票の **"連携 API／データパイプライン／AWS／MySQL／CI/CD／Docker"** すべてを 1 本のプロジェクトで練習できます。

## 1. 機能スコープ（MVP）

| ユースケース | 主要エンドポイント | 技術的ハイライト |
|---|---|---|
| **データ送信**<br>iOS 側が 15 分ごとに JSON でバッチ送信 | `POST /v1/measurements/bulk` | *FastAPI* + 認証（JWT） |
| **履歴取得**<br>日・週・月単位で本人の統計値を取得 | `GET /v1/measurements/summary?period=week` | 集計クエリ & キャッシュ |
| **ゴール設定**<br>「歩数1万歩」を登録／更新 | `PUT /v1/goals/{goal_id}` | RDB 正規化／PATCH vs PUT |
| **Webhook 通知**<br>ゴール達成時に iOS へ Push | `POST /v1/webhooks/goal-achieved` | 非同期イベント & 冪等性 |

## 2. システム構成図（簡略）

```
    iOS App ──┐
              │ HTTPS/JSON
              └──────────────►  ┌──────────────┐
                                │ API Gateway  │
                                │   (REST)     │
                                └─────┬────────┘
                                      ▼
                     AWS Lambda / or ECS Fargate + FastAPI
                                      ▼
                  ┌──────────────┐  Async Put    ───────┐
                  │  Amazon S3   │───────────────────┐  │
                  │   Raw Logs   │                   │  │
                  └─────┬────────┘                   │  │
                        ▼                            ▼  ▼
            AWS Glue (ETL) ──► RDS Aurora MySQL ◄─ CloudWatch Alarms
                        │                            ▲
                        └─► Athena / ML Job          │
                                                     ▼
                                        Amazon SES / SNS (通知)
```

* **API レイヤ**：FastAPI + Pydantic → AWS API Gateway→Lambda or Fargate
* **データレイク**：生データを **S3** に保存 → **Glue** ETL で整形 → **Aurora MySQL** へロード
* **分析/ML**：Athena でクエリ、または SageMaker Notebook でモデル検証
* **CI/CD**：GitHub Actions → Docker build → sam deploy / ECS rolling update
* **IaC**：Terraform または AWS SAM
* **監視**：CloudWatch Logs + Prometheus/Grafana (ecs/fargate)

## 3. 学習ロードマップ（4 週間モデル）

| 週 | ゴール | 具体タスク | 関連スキル |
|---|---|---|---|
| **1** | API MVP | FastAPI で CRUD + pytest & MySQL(local) | Python3系, RESTful設計, xUnit |
| **2** | コンテナ化 & CD | Dockerfile + docker‑compose, CI でテスト→イメージPush | Docker, Git, CI/CD |
| **3** | AWS 移行 | Terraform で VPC / Aurora / API Gateway / Lambda | AWSネットワーク, サーバーレス |
| **4** | パフォーマンス & ETL | MySQL Index/EXPLAIN、Glue Job、Athena で集計 | RDBチューニング, データパイプライン |

**ポイント** *毎週 "求人の必須スキル" に対応する deliverable を 1 つ出す* と覚える順序が自然です。

## 4. 代表コードスケルトン

```python
# main.py
from fastapi import FastAPI, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from crud import create_bulk_measurements, get_week_summary
from schemas import MeasurementBulkIn, SummaryOut
from deps import get_db, get_current_user

app = FastAPI(title="HealthSync API", version="1.0")

@app.post("/v1/measurements/bulk", status_code=201)
async def ingest_measurements(
    payload: MeasurementBulkIn,
    db: AsyncSession = Depends(get_db),
    user=Depends(get_current_user)
):
    await create_bulk_measurements(db, user.id, payload)
    return {"message": "accepted"}

@app.get("/v1/measurements/summary", response_model=SummaryOut)
async def read_summary(
    period: str = "week",
    db: AsyncSession = Depends(get_db),
    user=Depends(get_current_user)
):
    return await get_week_summary(db, user.id, period)
```

* **型ヒント**で IDE 支援 → 速い開発
* **AsyncSession** で非同期 IO → Lambda/Fargate でもスケール

## 5. パフォーマンス & 品質チェックリスト

| 項目 | 例 | 学習トピック |
|---|---|---|
| **Slow Query** | `EXPLAIN SELECT ...;` | Index, Covering Index, 復合KEY |
| **ロードテスト** | k6 / Locust | Lambda concurrency, RDS tuning |
| **CI Gate** | `pytest -q && flake8` | テスト自動化 & Lint |
| **Docker 最適化** | multi‑stage build, slim image | セキュリティ & ビルド時間短縮 |
| **Observability** | structured logging (logfmt/JSON) | Loki or CloudWatch Insight |

## 6. さらに差をつける "＋α"

| 追加要素 | 効果 |
|---|---|
| **Step Functions** で "ETL ワークフロー全体" を状態遷移図化 | サーバーレス設計力を可視化 |
| **Athena + QuickSight** でダッシュボード作成 | 分析〜可視化まで一気通貫 |
| **Feature Flags** (GrowthBook / LaunchDarkly OSS) | スクラムの A/B テストに強い |
| **ML 予測**（時系列異常検知）を Lambda Layer でデプロイ | 歓迎スキル「ML」を実務レベルに |

## ⛳️ まとめ：提案の狙い

1. **求人票に列挙された "必須スキル" を 100 % カバー**
2. **iOS 側の HealthKit 連携** という実際にあり得るユースケースを想定
3. **サーバーレス + データパイプライン** をワンストップで体験
4. 完成後は **GitHub リポジトリ & デプロイ済み Demo URL** を面談で提示でき、説得力◎

「まずは API MVP → Docker/CI → AWS 移行 → ETL & チューニング」という順で手を動かすと、実務さながらの流れでスキルが定着します。 もし詳細設計やサンプル Terraform が欲しければ、次のステップとして一緒に書き始めましょう！